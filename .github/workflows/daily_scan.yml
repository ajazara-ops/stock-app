name: Daily Stock Scanner

on:
  schedule:
    # 1. [í•œêµ­ ì£¼ì‹] ì›”~ê¸ˆ ì €ë… 18:30 KST (UTC 09:30)
    - cron: '30 9 * * 1-5'

    # 2. [ë¯¸êµ­ ì£¼ì‹] í™”~í†  ì•„ì¹¨ 08:15 KST (UTC 23:15)
    - cron: '15 23 * * 1-5'
    
    # 3. [ì£¼ê°„ ê²°ì‚°] í† ìš”ì¼ ì˜¤í›„ 17:00 KST (UTC 08:00)
    - cron: '0 8 * * 6'

  workflow_dispatch: 
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - daily
        - weekly
        - weekly_summary
        - notify
        - test_push
      target:
        description: 'ë¶„ì„ ì‹œì¥'
        required: false
        default: 'ALL'
        type: choice
        options:
        - ALL
        - US
        - KR

permissions:
  contents: write

jobs:
  run-scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # [ìˆ˜ì •] firebase-admin ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìˆ˜ ì„¤ì¹˜
          pip install yfinance pandas requests lxml firebase-admin

      - name: Run Scan Logic
        env:
          # [ì¤‘ìš”] GitHub Secretsì— ë“±ë¡í•œ í‚¤ë¥¼ íŒŒì´ì¬ í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…
          # (ì´ ë¶€ë¶„ì´ ì—†ì–´ì„œ ì•„ê¹Œ ê²½ê³ ê°€ ë–´ë˜ ê²ƒì…ë‹ˆë‹¤!)
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        run: |
          MODE="${{ inputs.mode }}"
          TARGET="${{ inputs.target }}"
          
          if [ -z "$MODE" ] || [ "$MODE" == "auto" ]; then
            HOUR=$(date +%H)
            DOW=$(date +%u)
            
            if [ "$DOW" -eq 6 ] && [ "$HOUR" -ge 8 ] && [ "$HOUR" -le 10 ]; then
              MODE="weekly_summary"
            elif [ "$HOUR" -ge 22 ] || [ "$HOUR" -le 1 ]; then
              MODE="daily"
              TARGET="US"
            elif [ "$HOUR" -ge 9 ] && [ "$HOUR" -le 12 ]; then
              MODE="daily"
              TARGET="KR"
            else
              echo "âš ï¸ ì‹¤í–‰ ì‹œê°„ì´ ì˜ˆìƒ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ($HOUR ì‹œ). ê¸°ë³¸ê°’(ALL)ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."
              MODE="daily"
              TARGET="ALL"
            fi
          fi
          
          echo "ğŸš€ ì‹¤í–‰ ëª¨ë“œ: $MODE / íƒ€ê²Ÿ: $TARGET (í˜„ì¬ì‹œê°„ UTC: $(date))"
          
          if [ "$MODE" == "weekly" ]; then
            python daily_stock_scanner.py --mode weekly
          elif [ "$MODE" == "weekly_summary" ]; then
            python daily_stock_scanner.py --mode weekly_summary
          elif [ "$MODE" == "notify" ]; then
            python daily_stock_scanner.py --mode notify
          elif [ "$MODE" == "test_push" ]; then
            python daily_stock_scanner.py --mode test_push
          else
            if [ -z "$TARGET" ]; then TARGET="ALL"; fi
            python daily_stock_scanner.py --mode daily --target $TARGET
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add todays_recommendation.json
          git add daily_data/*.json weekly_reports/*.json history_index.json || true
          
          git commit -m "Update Stock Data ($MODE mode)" || echo "No changes to commit"
          git push
