name: Daily Stock Scanner

on:
  schedule:
    # 1. [í•œêµ­ ì£¼ì‹] ì›”~ê¸ˆ ì €ë… 18:30 KST (UTC 09:30)
    # (ì„œë²„ í˜¼ì¡ì„ í”¼í•´ 30ë¶„ ëŠ¦ì¶¤)
    - cron: '30 9 * * 1-5'

    # 2. [ë¯¸êµ­ ì£¼ì‹] í™”~í†  ì•„ì¹¨ 08:15 KST (UTC 23:15)
    # (ì„œë²„ í˜¼ì¡ì„ í”¼í•´ 15ë¶„ ëŠ¦ì¶¤)
    - cron: '15 23 * * 1-5'
    
    # 3. [ì£¼ê°„ ê²°ì‚°] í† ìš”ì¼ ì˜¤í›„ 17:00 KST (UTC 08:00)
    - cron: '0 8 * * 6'

  workflow_dispatch: 
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - daily
        - weekly
        - weekly_summary
      target:
        description: 'ë¶„ì„ ì‹œì¥'
        required: false
        default: 'ALL'
        type: choice
        options:
        - ALL
        - US
        - KR

permissions:
  contents: write

jobs:
  run-scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # 3.11 ë²„ì „ ìœ ì§€

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # [ìˆ˜ì •] firebase-admin ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ ì„¤ì¹˜ (í•„ìˆ˜!)
          pip install yfinance pandas requests lxml firebase-admin

      - name: Run Scan Logic
        run: |
          MODE="${{ inputs.mode }}"
          TARGET="${{ inputs.target }}"
          
          # ìë™ ëª¨ë“œ('auto')ì´ê±°ë‚˜ ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì¸ ê²½ìš° ì‹œê°„ìœ¼ë¡œ íŒë‹¨
          if [ -z "$MODE" ] || [ "$MODE" == "auto" ]; then
            HOUR=$(date +%H)
            DOW=$(date +%u)
            
            # 1. í† ìš”ì¼(6) 08ì‹œ~10ì‹œ(UTC) -> í•œêµ­ í† ìš”ì¼ 17ì‹œ~19ì‹œ -> ì£¼ê°„ ê²°ì‚° ì•Œë¦¼
            # (ì§€ì—° ì‹¤í–‰ ê³ ë ¤í•˜ì—¬ ë²”ìœ„ë¡œ ì²´í¬)
            if [ "$DOW" -eq 6 ] && [ "$HOUR" -ge 8 ] && [ "$HOUR" -le 10 ]; then
              MODE="weekly_summary"
              
            # 2. 22ì‹œ~01ì‹œ(UTC) -> í•œêµ­ ì•„ì¹¨ 07ì‹œ~10ì‹œ -> ë¯¸êµ­ ì£¼ì‹(US) ë¶„ì„
            # (ì „ë‚  22ì‹œ ~ ë‹¹ì¼ 01ì‹œ ì‚¬ì´)
            elif [ "$HOUR" -ge 22 ] || [ "$HOUR" -le 1 ]; then
              MODE="daily"
              TARGET="US"
              
            # 3. 09ì‹œ~12ì‹œ(UTC) -> í•œêµ­ ì €ë… 18ì‹œ~21ì‹œ -> í•œêµ­ ì£¼ì‹(KR) ë¶„ì„
            # (ì§€ì—° ì‹¤í–‰ ê³ ë ¤í•˜ì—¬ 3ì‹œê°„ ë²”ìœ„)
            elif [ "$HOUR" -ge 9 ] && [ "$HOUR" -le 12 ]; then
              MODE="daily"
              TARGET="KR"
            
            # ê·¸ ì™¸ ì‹œê°„ (í˜¹ì‹œë‚˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ ì§€ì—° ë°œìƒ ì‹œ ì•ˆì „í•˜ê²Œ ALL)
            else
              echo "âš ï¸ ì‹¤í–‰ ì‹œê°„ì´ ì˜ˆìƒ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ($HOUR ì‹œ). ê¸°ë³¸ê°’(ALL)ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."
              MODE="daily"
              TARGET="ALL"
            fi
          fi
          
          echo "ğŸš€ ì‹¤í–‰ ëª¨ë“œ: $MODE / íƒ€ê²Ÿ: $TARGET (í˜„ì¬ì‹œê°„ UTC: $(date))"
          
          if [ "$MODE" == "weekly" ]; then
            python daily_stock_scanner.py --mode weekly
          elif [ "$MODE" == "weekly_summary" ]; then
            python daily_stock_scanner.py --mode weekly_summary
          else
            if [ -z "$TARGET" ]; then TARGET="ALL"; fi
            python daily_stock_scanner.py --mode daily --target $TARGET
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add todays_recommendation.json
          git add daily_data/*.json weekly_reports/*.json history_index.json || true
          
          git commit -m "Update Stock Data ($MODE mode)" || echo "No changes to commit"
          git push
